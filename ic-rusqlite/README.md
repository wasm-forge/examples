# Run Rusqlite on the Internet Computer

This project provides a convenience package that enables the use of an SQLite database within an Internet Computer canister. Follow the instructions below to integrate SQLite into your project.


## Prerequisites

You must have both [rust](https://doc.rust-lang.org/book/ch01-01-installation.html), and [dfx](https://internetcomputer.org/docs/current/developer-docs/setup/install/) installed.

To compile the `ic-rusqlite` package, you also need to install the [WASI Clang compiler](https://github.com/WebAssembly/wasi-sdk/releases/). After installation, the `clang` compiler is typically available at `/opt/wasi-sdk/bin`. If it’s installed in a different location, set the correct path using the `WASI_SDK` environment variable:

```bash
export WASI_SDK=/opt/wasi-sdk
```

Additionally, you'll need the `wasi2ic` tool to convert the WASI-compatible WebAssembly binary into a format compatible with the Internet Computer. Install it with:

```bash
cargo install wasi2ic
```

This tool rewires WASI system calls to their Internet Computer-compatible polyfills.


## Enabling the Sqlite

To enable SQLite support, add `ic-rusqlite` dependency to your backend canister:

```bash
cargo add ic-rusqlite
```

Next, update your canister’s `dfx.json` file to include the appropriate build command and a conversion call to `wasi2ic`. Make sure to point `"wasm"` to the output `.wasm` file generated by `wasi2ic`, and set the canister `"type"` to `"custom"`.

Here’s an example setup for a canister's `my-canister` backend:

```json
{
  "canisters": {
    "my-canister-backend": {
      "candid": "src/my-canister-backend/my-canister-backend.did",
      "package": "my-canister-backend",
      "build": [
        "cargo build --release --target wasm32-wasip1",
        "wasi2ic target/wasm32-wasip1/release/my_canister_backend.wasm target/wasm32-wasip1/release/no_wasi.wasm"
      ],
      "wasm": "target/wasm32-wasip1/release/no_wasi.wasm",
      "type": "custom"
    }
  },
  "defaults": {
    "build": {
      "args": "",
      "packtool": ""
    }
  },
  "output_env_file": ".env",
  "version": 1
}
```


## Using the database

The package provides convenience builder methods to setup a new database connection. It has some reasonable defaults but it can still be fine-tuned for custom needs.

Connect to the database using the connection builder. If you don't want to change the default settings, just connect as follows:

```rust
#[ic_cdk::init]
pub fn init() {
  let db_connect = DbConnectionBuilder::new();
  db_connect.connect();

  // create/initialize tables, if necessary
  create_tables();
}
```

### Canister upgrades

Before upgrading canister, you need to close the database connection:
```rust
//...
#[ic_cdk::pre_upgrade]
pub fn pre_upgrade() {
  disconnect();
}
```

This closes the connection and unmounts the database file.

### Post-upgrade

Works the same as during the initialization, connect using the same settings as 

```rust
#[ic_cdk::upgrade]
pub fn upgrade() {
  let db_connect = DbConnectionBuilder::new();
  db_connect.connect();

}
```

